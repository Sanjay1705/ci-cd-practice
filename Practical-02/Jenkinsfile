pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Test') {
      steps {
        dir('Practical-02') {
          sh '''
            echo "[INFO] Installing dependencies..."
            pip3 install --upgrade pip --break-system-packages
            pip3 install -r requirements.txt pytest --break-system-packages
            echo "[INFO] Running pytest..."
            python3 -m pytest -q
          '''
        }
      }
    }

    stage('Build Docker') {
      steps {
        dir('Practical-02') {
          sh '''
            echo "[INFO] Building Docker image..."
            docker build -t ci-web .
          '''
        }
      }
    }

    stage('Run & Health-check') {
      steps {
        dir('Practical-02') {
          sh '''
            echo "[INFO] Cleaning up any existing ci-web container..."
            docker rm -f ci-web || true

            echo "[INFO] Running container..."
            docker run -d --name ci-web -p 5000:5000 ci-web

            echo "[INFO] Checking health endpoint..."
            for i in {1..10}; do
              sleep 2
              STATUS=$(docker inspect -f '{{.State.Status}}' ci-web)
              echo "Attempt $i: Container status = $STATUS"
              RESPONSE=$(curl -s http://localhost:5000/health)
              echo "Attempt $i: Response = $RESPONSE"
              if echo "$RESPONSE" | python3 -c "import sys,json; j=json.load(sys.stdin); assert j.get('status')=='ok'" 2>/dev/null; then
                echo "[INFO] Health check passed"
                exit 0
              fi
            done

            echo "[ERROR] Health check failed"
            echo "[DEBUG] Container logs:"
            docker logs ci-web | tail -n 20
            exit 1
          '''
        }
      }
    }
  }

  post {
    always {
      sh '''
        echo "[INFO] Cleaning up containers..."
        docker ps -a --format "{{.Names}}" | grep -w ci-web && docker rm -f ci-web || echo "[INFO] ci-web already removed"
      '''
    }
  }
}